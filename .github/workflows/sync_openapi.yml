name: Sync OpenAPI Spec

on:
  schedule:
    - cron: '0 6 * * 1'  # Monday 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-regenerate:
    name: Sync & Regenerate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Beam
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.20'
          otp-version: '28'

      - name: Install dependencies
        run: mix deps.get

      - name: Record current version
        id: old_version
        run: |
          if [ -f OPENAPI_VERSION ]; then
            echo "version=$(cat OPENAPI_VERSION)" >> "$GITHUB_OUTPUT"
          else
            echo "version=unknown" >> "$GITHUB_OUTPUT"
          fi
          echo "file_count=$(find priv/openapi -name '*.json' 2>/dev/null | wc -l | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Sync spec
        run: bash scripts/sync_openapi.sh

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet priv/openapi/ OPENAPI_VERSION 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Regenerate SDK
        if: steps.changes.outputs.changed == 'true'
        run: mix whatsapp.generate --clean --stats

      - name: Verify - compile
        if: steps.changes.outputs.changed == 'true'
        run: mix compile --warnings-as-errors

      - name: Verify - test
        if: steps.changes.outputs.changed == 'true'
        run: mix test

      - name: Verify - format
        if: steps.changes.outputs.changed == 'true'
        run: mix format --check-formatted

      - name: Verify - credo
        if: steps.changes.outputs.changed == 'true'
        run: mix credo --strict

      - name: Analyze changes
        if: steps.changes.outputs.changed == 'true'
        id: analyze
        run: |
          NEW_VERSION=$(cat OPENAPI_VERSION)
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

          NEW_FILE_COUNT=$(find priv/openapi -name '*.json' | wc -l | tr -d ' ')
          echo "new_file_count=${NEW_FILE_COUNT}" >> "$GITHUB_OUTPUT"

          MODIFIED=$(git diff --name-only priv/openapi/ | wc -l | tr -d ' ')
          ADDED=$(git ls-files --others --exclude-standard priv/openapi/ | wc -l | tr -d ' ')
          REMOVED=$(git diff --name-only --diff-filter=D priv/openapi/ | wc -l | tr -d ' ')
          echo "modified=${MODIFIED}" >> "$GITHUB_OUTPUT"
          echo "added=${ADDED}" >> "$GITHUB_OUTPUT"
          echo "removed=${REMOVED}" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: openapi-sync/${{ steps.analyze.outputs.new_version }}
          commit-message: "Sync OpenAPI spec ${{ steps.analyze.outputs.new_version }}"
          title: "Sync OpenAPI spec: ${{ steps.old_version.outputs.version }} â†’ ${{ steps.analyze.outputs.new_version }}"
          body: |
            ## OpenAPI Spec Sync

            | Detail | Value |
            |--------|-------|
            | **Previous version** | `${{ steps.old_version.outputs.version }}` |
            | **New version** | `${{ steps.analyze.outputs.new_version }}` |
            | **Previous file count** | ${{ steps.old_version.outputs.file_count }} |
            | **New file count** | ${{ steps.analyze.outputs.new_file_count }} |
            | **Modified files** | ${{ steps.analyze.outputs.modified }} |
            | **Added files** | ${{ steps.analyze.outputs.added }} |
            | **Removed files** | ${{ steps.analyze.outputs.removed }} |

            ### Verification Checklist

            - [x] SDK regenerated (`mix whatsapp.generate --clean --stats`)
            - [x] Compilation passed (`mix compile --warnings-as-errors`)
            - [x] Tests passed (`mix test`)
            - [x] Formatting verified (`mix format --check-formatted`)
            - [x] Credo passed (`mix credo --strict`)

            ---
            *This PR was automatically generated by the [Sync OpenAPI Spec](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.*
          labels: |
            openapi-sync
            automated
