name: CI

on: [push, pull_request]

jobs:
  test:
    name: Test (Elixir ${{ matrix.elixir }} / OTP ${{ matrix.otp }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        elixir: ["1.19"]
        otp: ["27", "28"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      - name: Cache deps and _build
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: test-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            test-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile
        run: mix compile --warnings-as-errors

      - name: Run tests
        run: mix test

  quality:
    name: Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28"

      - name: Cache deps, _build, and PLTs
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
            priv/plts
          key: quality-${{ runner.os }}-1.19-28-${{ hashFiles('mix.lock') }}
          restore-keys: |
            quality-${{ runner.os }}-1.19-28-

      - name: Install dependencies
        run: mix deps.get

      - name: Check formatting
        run: mix format --check-formatted

      - name: Credo
        run: mix credo --strict

      - name: Dialyzer
        run: mix dialyzer

  codegen:
    name: Codegen Verify
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28"

      - name: Install dependencies
        run: mix deps.get

      - name: Generate (pass 1)
        run: mix whatsapp.generate --clean

      - name: Checksum pass 1
        run: find lib -name '*.ex' -print0 | sort -z | xargs -0 sha256sum > /tmp/pass1.txt

      - name: Generate (pass 2)
        run: mix whatsapp.generate --clean

      - name: Checksum pass 2
        run: find lib -name '*.ex' -print0 | sort -z | xargs -0 sha256sum > /tmp/pass2.txt

      - name: Diff passes
        run: diff /tmp/pass1.txt /tmp/pass2.txt

      - name: Compile
        run: mix compile --warnings-as-errors

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    env:
      WHATSAPP_ACCESS_TOKEN: ${{ secrets.WHATSAPP_ACCESS_TOKEN }}
      WHATSAPP_PHONE_NUMBER_ID: ${{ secrets.WHATSAPP_PHONE_NUMBER_ID }}
      WHATSAPP_BUSINESS_ACCOUNT_ID: ${{ secrets.WHATSAPP_BUSINESS_ACCOUNT_ID }}
      WHATSAPP_APP_SECRET: ${{ secrets.WHATSAPP_APP_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28"

      - name: Install dependencies
        run: mix deps.get

      - name: Run integration tests
        run: mix test --only integration
